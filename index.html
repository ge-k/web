<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>校园运动器材管理系统</title>
  <!-- 引入Google字体 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* 颜色变量 */
      --primary-color: #007bff;
      --primary-light: #e9f5ff;
      --primary-dark: #0056b3;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --success-light: #e5f9ee;
      --danger-color: #dc3545;
      --danger-light: #fae8ea;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --text-main: #333333;
      --text-secondary: #666666;
      --text-light: #999999;
      --border-color: #e9ecef;
      --background-color: #f5f5f5;
      --card-bg: #ffffff;
      
      /* 尺寸变量 */
      --border-radius: 12px;
      --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      --card-shadow-hover: 0 12px 28px rgba(0, 0, 0, 0.15);
      --btn-shadow: 0 4px 10px rgba(0, 123, 255, 0.25);
      --transition-speed: 0.3s;
      
      /* 暗色模式变量（预设，后面会用） */
      --dark-bg: #1a1a1a;
      --dark-card-bg: #2d2d2d;
      --dark-text-main: #f8f9fa;
      --dark-text-secondary: #adb5bd;
      --dark-border-color: #444444;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Noto Sans SC', 'Roboto', 'Microsoft YaHei', sans-serif;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      background-color: var(--background-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: var(--text-main);
      line-height: 1.6;
      margin: 0;
      transition: background-color var(--transition-speed) ease;
    }
    
    .container {
      width: 100%;
      max-width: 1100px;
      padding: 30px;
      margin: 20px auto;
      display: grid;
      gap: 30px;
    }
    
    .card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: var(--card-shadow);
      transition: all var(--transition-speed) ease;
      overflow: hidden;
      animation: fadeIn 0.5s ease-out;
    }
    
    .card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-5px);
    }
    
    h1, h2, h3 {
      color: var(--text-main);
      margin-bottom: 25px;
      text-align: center;
      letter-spacing: 0.5px;
      font-weight: 700;
    }
    
    h1 {
      font-size: 28px;
      margin-top: 15px;
      position: relative;
    }
    
    h2 {
      font-size: 24px;
      color: var(--primary-color);
    }
    
    h3 {
      font-size: 20px;
      color: var(--secondary-color);
    }
    
    .branding {
      text-align: center;
      margin-bottom: 20px;
      animation: fadeIn 1.5s ease-in-out;
    }
    
    .branding-future {
      display: inline-block;
      color: transparent;
      background: linear-gradient(45deg, var(--primary-color), var(--info-color));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 600;
      font-size: 22px;
      margin-bottom: 10px;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0, 123, 255, 0.1);
      animation: pulse 2s infinite alternate;
    }
    
    .branding-title {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 0.8px;
      margin: 0;
      position: relative;
      display: inline-block;
      padding: 0 10px;
      z-index: 1;
    }
    
    .branding-title::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background-color: rgba(0, 123, 255, 0.2);
      z-index: -1;
      border-radius: 4px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
      color: var(--text-main);
      letter-spacing: 0.3px;
      transition: color 0.3s ease;
    }
    
    input {
      width: 100%;
      padding: 14px 18px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      background-color: var(--light-color);
      color: var(--text-main);
      transition: all 0.3s ease;
    }
    
    input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
      outline: none;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 14px 24px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      width: 100%;
      box-shadow: var(--btn-shadow);
    }
    
    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(0, 123, 255, 0.25);
    }
    
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    button:active::after {
      animation: ripple 0.6s ease-out;
    }
    
    .hidden {
      display: none;
    }
    
    .menu {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 35px;
      flex-wrap: wrap;
    }
    
    .menu button {
      flex: 1;
      min-width: 120px;
      max-width: 200px;
      padding: 12px 20px;
      border-radius: 10px;
    }
    
    .tab-panel {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 25px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      border-radius: 10px;
    }
    
    table, th, td {
      padding: 12px 8px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
    }
    
    th, td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    th {
      background-color: var(--light-color);
      font-weight: 600;
      color: var(--primary-color);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.01);
    }
    
    tr {
      transition: background-color 0.3s ease;
    }
    
    tr:hover {
      background-color: rgba(0, 123, 255, 0.05);
    }
    
    .login-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .login-tab {
      padding: 14px 20px;
      border: none;
      background-color: var(--light-color);
      cursor: pointer;
      font-weight: 500;
      flex: 1;
      max-width: 180px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .login-tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: var(--primary-color);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .login-tab.active {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 4px 10px rgba(0, 123, 255, 0.25);
    }
    
    .login-tab:hover:not(.active) {
      background-color: rgba(0, 123, 255, 0.1);
    }
    
    .login-tab:hover::after {
      transform: scaleX(1);
    }
    
    .login-panel {
      padding: 30px;
      border-radius: 12px;
      background-color: var(--card-bg);
      animation: fadeIn 0.5s ease;
    }
    
    .device-info {
      margin: 25px 0;
      padding: 20px;
      background-color: var(--light-color);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }
    
    .device-info:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
    
    .device-info p {
      margin-bottom: 12px;
      font-size: 16px;
    }
    
    .result {
      font-size: 18px;
      margin: 15px 0;
      font-weight: 600;
      color: var(--text-main);
      padding: 8px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    
    .door-control {
      display: flex;
      margin-top: 25px;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .door-open {
      background-color: var(--success-color);
    }
    
    .door-closed {
      background-color: var(--danger-color);
    }
    
    /* 响应式设计 */
    @media screen and (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 0;
        width: 100%;
        max-width: 100%;
      }
      
      .card {
        padding: 20px;
        border-radius: 8px;
      }
      
      .menu {
        flex-direction: column;
        gap: 15px;
      }
      
      .menu button {
        max-width: none;
        padding: 12px 12px;
      }
      
      .status-display {
        padding: 15px 10px;
      }
      
      .status-items {
        gap: 10px;
      }
      
      .status-item {
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }
      
      .status-label {
        margin-bottom: 5px;
      }
      
      .status-value {
        align-self: stretch;
        text-align: center;
      }
      
      .login-tabs {
        flex-direction: row;
      }
      
      .login-tab {
        padding: 12px 5px;
      }
      
      .qrcode-image-container {
        max-width: 85vw;
      }
      
      .qrcode-image {
        max-width: 100%;
        height: auto;
      }
      
      table, th, td {
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: clip !important;
        text-align: center;
        padding: 10px 6px;
      }
      
      td:nth-child(1) { min-width: 80px; } /* 账号 */
      td:nth-child(3) { min-width: 100px; } /* 时期 */
      td:nth-child(4) { min-width: 50px; } /* 柜子 */
      td:nth-child(5) { min-width: 60px; } /* 器材 */
      td:last-child { 
        min-width: 90px;
        padding-right: 20px;
      } /* 状态 */
      
      /* 状态单元格样式保持不变 */
      .status-cell {
        padding: 6px 16px;
        margin: 0 auto;
        transform: translateX(-5px);
      }
      
      /* 状态列保持一行 */
      td:last-child, th:last-child {
        white-space: nowrap;
        width: auto;
        min-width: 70px;
      }
      
      /* 其他列允许占用多行 */
      td:not(:last-child), th:not(:last-child) {
        min-width: 60px;
        max-width: 100px;
      }
      
      /* 调整表格布局 */
      table {
        table-layout: fixed;
        width: 100%;
      }
      
      /* 调整选择框列宽度 */
      .show-select td:first-child,
      .show-select th:first-child {
        width: 30px;
        min-width: 30px;
        max-width: 30px;
      }
      
      input, button, select {
        font-size: 16px; /* 避免iOS自动缩放 */
      }
      
      h1 {
        font-size: 24px;
      }
      
      h2 {
        font-size: 20px;
      }
      
      h3 {
        font-size: 18px;
      }
      
      .branding-future {
        font-size: 18px;
      }
      
      .branding-title {
        font-size: 22px;
      }
      
      button {
        padding: 12px 18px;
        width: 100%;
      }
      
      /* 添加安卓特定的触摸反馈 */
      @media (hover: none) {
        button:active {
          background-color: var(--primary-dark);
        }
        
        .status-cell:active {
          opacity: 0.7;
        }
      }
    }
    
    /* 针对更小屏幕的手机 */
    @media screen and (max-width: 480px) {
      .card {
        padding: 15px;
        border-radius: 10px;
      }
      
      table, th, td {
        padding: 6px;
        font-size: 13px;
      }
      
      .menu button {
        font-size: 14px;
        padding: 10px 15px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      h2 {
        font-size: 18px;
      }
      
      h3 {
        font-size: 16px;
      }
      
      .branding-future {
        font-size: 16px;
      }
      
      .branding-title {
        font-size: 20px;
      }
      
      #login-section h3 {
        font-size: 16px;
        margin-bottom: 8px;
      }
      
      #login-section h1 {
        font-size: 20px;
      }
      
      #teacher-exception th,
      #teacher-exception td {
        padding: 6px;
        font-size: 11px;
      }
      
      td:not(:last-child), th:not(:last-child) {
        min-width: 50px;
        max-width: 80px;
      }
    }
    
    /* 状态单元格样式 */
    .status-cell {
      padding: 6px 16px;  /* 增加左右内边距 */
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      display: inline-block;
      margin: 0 auto;     /* 水平居中 */
      min-width: 70px;    /* 确保最小宽度 */
      text-align: center; /* 文字居中 */
    }
    
    .status-cell[data-status="pending"] {
      background-color: #fef1f1;
      color: #dc3545;
    }
    
    .status-cell[data-status="done"] {
      background-color: #e5f9ee;
      color: #28a745;
    }
    
    @media screen and (max-width: 768px) {
      /* 调整状态列宽度和对齐方式 */
      td:last-child {
        padding-right: 20px;  /* 增加右侧空间 */
        text-align: center;   /* 确保居中 */
        min-width: 90px;      /* 增加最小宽度 */
      }
      
      .status-cell {
        padding: 6px 16px;    /* 保持一致的内边距 */
        margin: 0 auto;       /* 水平居中 */
        transform: translateX(-5px); /* 稍微向左偏移以确保圆弧完整显示 */
      }
    }
    
    /* 实时状态显示样式 */
    .status-display {
      margin: 20px 0;
      padding: 20px;
      background-color: var(--light-color);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    
    .status-display:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      transform: translateY(-3px);
    }
    
    .status-title {
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .status-items {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      padding: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    
    .status-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
    
    .status-label {
      margin-right: 10px;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .status-value {
      font-size: 18px;
      font-weight: 600;
      padding: 5px 12px;
      border-radius: 8px;
    }
    
    .status-toggle {
      background: none;
      border: none;
      color: var(--secondary-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 5px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .status-toggle:hover {
      background-color: rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
    }
    
    .status-toggle:active {
      transform: translateY(1px);
    }
    
    /* QR码显示样式 */
    .qrcode-container {
      text-align: center;
      margin: 25px 0;
      padding: 20px;
    }
    
    .qrcode-title {
      margin-bottom: 20px;
      font-size: 20px;
      color: var(--text-main);
    }
    
    .qrcode-image-container {
      display: inline-block;
      padding: 15px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }
    
    .qrcode-image-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }
    
    .qrcode-image {
      max-width: 100%;
      height: auto;
    }
    
    .qrcode-hint {
      margin-top: 20px;
      color: var(--text-secondary);
      font-size: 15px;
    }
    
    /* 动画 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes pulse {
      from { opacity: 0.8; transform: scale(1); }
      to { opacity: 1; transform: scale(1.03); }
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(30, 30);
        opacity: 0;
      }
    }
    
    /* 暗黑模式切换按钮 */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background-color: var(--card-bg);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .theme-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }
    
    .theme-toggle svg {
      width: 22px;
      height: 22px;
      color: var(--text-main);
      transition: all 0.3s ease;
    }
    
    /* 暗黑模式样式 */
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text-main);
    }
    
    body.dark-mode .card,
    body.dark-mode .login-panel {
      background-color: var(--dark-card-bg);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    body.dark-mode h1, 
    body.dark-mode h2, 
    body.dark-mode h3 {
      color: var(--dark-text-main);
    }
    
    body.dark-mode .device-info,
    body.dark-mode .status-display {
      background-color: rgba(255, 255, 255, 0.05);
      border-color: var(--dark-border-color);
    }
    
    body.dark-mode input {
      background-color: rgba(255, 255, 255, 0.05);
      border-color: var(--dark-border-color);
      color: var(--dark-text-main);
    }
    
    body.dark-mode label,
    body.dark-mode .status-label {
      color: var(--dark-text-secondary);
    }
    
    body.dark-mode table {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    body.dark-mode th {
      background-color: rgba(0, 123, 255, 0.1);
    }
    
    body.dark-mode td {
      border-bottom-color: var(--dark-border-color);
    }
    
    body.dark-mode tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.02);
    }
    
    body.dark-mode tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    body.dark-mode .login-tab:not(.active) {
      background-color: rgba(255, 255, 255, 0.05);
      color: var(--dark-text-main);
    }
    
    body.dark-mode .login-tab:hover:not(.active) {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    body.dark-mode .search-input {
      background-color: rgba(255, 255, 255, 0.05);
      border-color: var(--dark-border-color);
      color: var(--dark-text-main);
    }
    
    body.dark-mode .status-item {
      background-color: rgba(255, 255, 255, 0.05);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    body.dark-mode .theme-toggle {
      background-color: var(--dark-card-bg);
    }
    
    body.dark-mode .theme-toggle svg {
      color: var(--dark-text-main);
    }

    /* 清除历史记录按钮样式 */
    .clear-history-container {
      text-align: right;
      margin: 15px 0;
    }
    
    .clear-history-btn {
      background-color: var(--danger-color);
      max-width: 150px;
      padding: 10px 20px;
    }
    
    .clear-history-btn:hover {
      background-color: #c82333;
    }
    
    /* 默认隐藏选择相关元素 - 放在其他样式之前 */
    .exception-select, #exception-select-all, #delete-exception-btn, 
    #teacher-exception th:first-child, #teacher-exception td:first-child {
      display: none !important;
    }
    
    /* 选择模式时显示 */
    .show-select .exception-select, 
    .show-select #exception-select-all, 
    .show-select #delete-exception-btn,
    .show-select #teacher-exception th:first-child,
    .show-select #teacher-exception td:first-child {
      display: table-cell !important;
    }
    
    .show-select #delete-exception-btn {
      display: block !important;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      border-radius: 50px;
      padding: 12px 24px;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
      animation: fadeIn 0.3s ease;
    }

    /* 隐藏姓名列 */
    #teacher-exception td:nth-child(3),
    #teacher-exception th:nth-child(3) {
      display: none !important;
    }

    /* 确保其他列显示 */
    #teacher-exception td,
    #teacher-exception th {
      display: table-cell;
    }

    /* 选择模式下的第一列（复选框列）保持隐藏逻辑 */
    #teacher-exception td:first-child,
    #teacher-exception th:first-child {
      display: none;
    }

    .show-select #teacher-exception td:first-child,
    .show-select #teacher-exception th:first-child {
      display: table-cell;
      width: 40px;
    }

    .qrcode-image{display:flex;justify-content:center;align-items:center;margin:0 auto;width:200px;height:200px;}
    .qrcode-container{text-align:center;}
  </style>
</head>
<body>
  <!-- 暗黑模式切换按钮 -->
  <div class="theme-toggle" id="theme-toggle">
    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </div>

  <div class="container">
    <!-- 登录界面 -->
    <div id="login-section" class="card">
      <div class="branding">
        <div class="branding-future">2025嵌入式大赛</div>
        <h1 class="branding-title">校园运动器材管理系统</h1>
      </div>
      <div class="login-tabs">
        <button id="student-tab" class="login-tab active">学生登录</button>
        <button id="teacher-tab" class="login-tab">教师登录</button>
      </div>
      
      <div id="student-login" class="login-panel">
        <div class="form-group">
          <label for="student-username">账号</label>
          <input type="text" id="student-username" value="210797">
        </div>
        <div class="form-group">
          <label for="student-password">密码</label>
          <input type="password" id="student-password" value="210797">
        </div>
        <button id="student-login-btn">登录</button>
      </div>
      
      <div id="teacher-login" class="login-panel hidden">
        <div class="form-group">
          <label for="teacher-username">账号</label>
          <input type="text" id="teacher-username" value="359921">
        </div>
        <div class="form-group">
          <label for="teacher-password">密码</label>
          <input type="password" id="teacher-password" value="359921">
        </div>
        <button id="teacher-login-btn">登录</button>
      </div>
    </div>

    <!-- 学生功能界面 -->
    <div id="student-dashboard" class="card hidden">
      <div class="branding">
        <div class="branding-future">2025嵌入式大赛</div>
        <h1 class="branding-title">校园运动器材管理系统</h1>
      </div>
      <h2>学生功能界面</h2>
      <div class="menu">
        <button class="menu-btn" data-target="student-history">历史记录</button>
        <button class="menu-btn" data-target="student-qrcode">查看二维码</button>
        <button id="student-logout">退出登录</button>
      </div>

      <!-- 历史记录界面 -->
      <div id="student-history" class="tab-panel">
        <h2>历史使用记录</h2>
        
        <!-- 添加清除按钮 -->
        <div class="clear-history-container">
          <button id="clear-history-btn" class="clear-history-btn">清除历史记录</button>
        </div>
        
        <!-- 添加实时状态显示区域 -->
        <div class="status-display">
          <div class="status-title">实时设备状态</div>
          <div class="status-items">
            <div class="status-item">
              <span class="status-label">使用状态(use_flag):</span>
              <span id="current-use-flag" class="status-value" style="color: var(--primary-color); background: var(--primary-light);">false</span>
            </div>
            <div class="status-item">
              <span class="status-label">器材类型(equipment_type):</span>
              <span id="current-student-equipment-type" class="status-value" style="color: var(--success-color); background: var(--success-light);">乒乓球</span>
            </div>
            <div class="status-item">
              <span class="status-label">使用时长(use_time):</span>
              <span id="current-use-time" class="status-value" style="color: var(--danger-color); background: var(--danger-light);">0</span> 秒
            </div>
          </div>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>日期</th>
              <th>器材</th>
              <th>使用时长</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <!-- 历史记录将在JavaScript中动态生成 -->
          </tbody>
        </table>
      </div>

      <!-- 二维码界面 -->
      <div id="student-qrcode" class="tab-panel">
        <h2>学生二维码</h2>
        <div class="qrcode-container">
          <p class="qrcode-title">个人识别二维码</p>
          <div id="qrcode-image" class="qrcode-image"></div>
          <p class="qrcode-hint">请在设备前出示此二维码</p>
        </div>
      </div>
    </div>

    <!-- 教师功能界面 -->
    <div id="teacher-dashboard" class="card hidden">
      <div class="branding">
        <div class="branding-future">2025嵌入式大赛</div>
        <h1 class="branding-title">校园运动器材管理系统</h1>
      </div>
      <h2>教师功能界面</h2>
      <div class="menu">
        <button class="menu-btn" data-target="teacher-door">开关门柜</button>
        <button class="menu-btn" data-target="teacher-exception">异常处理</button>
        <button class="menu-btn" data-target="teacher-qrcode">查看二维码</button>
        <button id="teacher-logout">退出登录</button>
      </div>

      <!-- 开关门柜界面 -->
      <div id="teacher-door" class="tab-panel">
        <h2>开关门柜管理</h2>
        <div class="door-control">
          <button id="door2-toggle" class="door-btn">加载中...</button>
        </div>
        
        <div class="device-info">
          <h3>设备状态</h3>
          <p class="result" id="lock1-status">门2状态: 查询中...</p>
          <p class="result" id="lock2-update-time">最后更新时间: 查询中...</p>
        </div>
      </div>

      <!-- 异常处理界面 -->
      <div id="teacher-exception" class="tab-panel">
        <h2>归还超时记录</h2>
        <div style="margin-bottom:10px;display:flex;justify-content:flex-end"><button id="delete-exception-btn" style="background:#dc3545;color:#fff;border:none;border-radius:18px;padding:4px 14px;font-size:13px;box-shadow:0 2px 8px #dc354533;cursor:pointer;transition:all .2s;display:inline-block;min-width:auto;width:auto;">删除选中记录</button></div>
        <!-- 添加错误标志显示区域 -->
        <div class="status-display">
          <div class="status-title">
            <span></span>
            <button id="toggle-monitor-data" class="status-toggle">
              <span id="toggle-text"></span>
            </button>
          </div>
          <div id="monitor-data-content" class="status-items" style="display: none;">
            <div class="status-item">
              <span class="status-label">错误标志(error_flag):</span>
              <span id="current-error-flag" class="status-value" style="color: var(--primary-color); background: var(--primary-light);">0</span>
            </div>
            <div class="status-item">
              <span class="status-label">柜子号(cabinet):</span>
              <span id="current-cabinet" class="status-value" style="color: var(--success-color); background: var(--success-light);">0</span>
            </div>
            <div class="status-item">
              <span class="status-label">器材类型(equipment_type):</span>
              <span id="current-equipment-type" class="status-value" style="color: var(--danger-color); background: var(--danger-light);">乒乓球</span>
            </div>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="exception-select-all"></th>
              <th>账号</th>
              <th>时期</th>
              <th>柜子</th>
              <th>器材</th>
              <th>状态</th>
            </tr>
          </thead>
          <tbody id="exception-table-body">
            <!-- 异常记录将动态生成 -->
          </tbody>
        </table>
      </div>

      <!-- 教师二维码界面 -->
      <div id="teacher-qrcode" class="tab-panel">
        <h2>教师二维码</h2>
        <div class="qrcode-container">
          <p class="qrcode-title">教师识别二维码</p>
          <div id="teacher-qrcode-image" class="qrcode-image"></div>
          <p class="qrcode-hint">请在设备前出示此二维码</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化暗黑模式
      initDarkMode();

      // 设置默认账号密码
      document.getElementById('student-username').value = '210797';
      document.getElementById('student-password').value = '210797';
      document.getElementById('teacher-username').value = '359921';
      document.getElementById('teacher-password').value = '359921';
      
      // 设备状态变量
      let deviceVariables = {
        use_flag: 0,  // 改为int32类型
        equipment_type: 0,
        use_time: 0,
        错误标志: 0,
        cabinet: 0,
        Lock1: false,
        Lock2: false
      };
      
      // 保存上一个状态的use_flag，用于检测变化
      let previousUseFlag = 0;  // 改为int32类型
      
      // 添加计时器相关变量
      // 计时器全局唯一挂载
      if(!window.timerStartTime)window.timerStartTime={'210797':0,'175905':0,'175908':0};
      if(!window.timerInterval)window.timerInterval={'210797':null,'175905':null,'175908':null};
      if(!window.timerCurrent)window.timerCurrent={'210797':0,'175905':0,'175908':0};
      
      // 开始计时函数
      function startTimer(account) {
        console.log(`开始计时 - 账号: ${account}`); // 添加调试日志
        if (window.timerInterval[account]) {
          console.log(`账号 ${account} 已有计时器在运行，先清除`);
          clearInterval(window.timerInterval[account]);
        }
        
        window.timerStartTime[account] = Date.now();
        window.timerCurrent[account] = 0;
        window.timerInterval[account] = setInterval(() => {
          window.timerCurrent[account] = Math.floor((Date.now() - window.timerStartTime[account]) / 1000);
          
          // 如果当前登录的是这个账号，则更新显示
          const currentUser = document.getElementById('student-username').value;
          if (currentUser === account) {
            const useTimeDisplay = document.getElementById('current-use-time');
            if (useTimeDisplay) {
              useTimeDisplay.textContent = window.timerCurrent[account];
            }
          }
        }, 1000);
      }
      
      // 停止计时函数
      function stopTimer(account) {
        console.log(`停止计时 - 账号: ${account}`); // 添加调试日志
        if (window.timerInterval[account]) {
          clearInterval(window.timerInterval[account]);
          window.timerInterval[account] = null;
          
          // 计算最终使用时长（秒）
          const finalTime = Math.floor((Date.now() - window.timerStartTime[account]) / 1000);
          window.timerStartTime[account] = 0;
          
          window.timerCurrent[account] = finalTime;
          console.log(`计时结束 - 账号: ${account}, 最终时长: ${finalTime}秒`);
          
          // 更新显示
          if (document.getElementById('student-username').value === account) {
            const useTimeDisplay = document.getElementById('current-use-time');
            if (useTimeDisplay) {
              useTimeDisplay.textContent = finalTime;
            }
          }
          
          return finalTime;
        }
        return 0;
      }
      
      // 初始化历史记录
      generateInitialHistoryRecords();
      
      // 初始化异常记录存储
      initExceptionStorage();
      
      // 按钮点击波纹效果
      addRippleEffect();
      
      // 为门按钮添加样式
      setupDoorButtons();
      
      // 暗黑模式切换
      function initDarkMode() {
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        // 检查本地存储或系统偏好
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && prefersDarkMode)) {
          document.body.classList.add('dark-mode');
          themeIcon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
        }
        
        // 点击切换主题
        themeToggle.addEventListener('click', function() {
          document.body.classList.toggle('dark-mode');
          
          if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            themeIcon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
          } else {
            localStorage.setItem('theme', 'light');
            themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
          }
          
          // 添加切换动画
          themeToggle.classList.add('theme-transition');
          setTimeout(() => {
            themeToggle.classList.remove('theme-transition');
          }, 300);
        });
      }
      
      // 生成初始的历史记录数据
      function generateInitialHistoryRecords() {
        const historyTableBody = document.getElementById('history-table-body');
        if (!historyTableBody) return;
        
        // 清空现有记录
        historyTableBody.innerHTML = '';
        
        // 获取当前登录的用户账号
        const currentUser = document.getElementById('student-username').value;
        console.log('当前登录账号:', currentUser); // 调试日志
        
        // 从本地存储加载当前用户的历史记录
        const storageKey = `history_${currentUser}`; // 使用独立的存储键
        const userRecords = JSON.parse(localStorage.getItem(storageKey) || '[]');
        console.log(`加载${currentUser}的历史记录:`, userRecords); // 调试日志
        
        // 显示当前用户的记录
        userRecords.forEach(record => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${record.date}</td><td>${record.equipment}</td><td>${isNaN(record.duration)?record.duration:formatDuration(record.duration)}</td>`;
          historyTableBody.appendChild(row);
        });
        
        // 更新总时长统计
        updateTotalHours(currentUser);
      }
      
      // 更新总时长统计
      function updateTotalHours(userId) {
        const totalHoursElement = document.getElementById('total-year-hours');
        if (!totalHoursElement) return;
        
        // 获取当前用户的历史记录
        const userRecords = JSON.parse(localStorage.getItem(`history_${userId}`) || '[]');
        
        // 计算总时长（分钟）
        const totalMinutes = userRecords.reduce((total, record) => {
          return total + parseInt(record.duration || 0);
        }, 0);
        
        // 转换为小时并显示（保留一位小数）
        const totalHours = (totalMinutes / 60).toFixed(1);
        totalHoursElement.textContent = totalHours;
      }
      
      // 插入新的历史记录
      function insertNewHistoryRecord(date, isOngoing) {
        const historyTableBody = document.getElementById('history-table-body');
        if (!historyTableBody) return;
        
        // 获取当前用户
        const currentUser = document.getElementById('student-username').value;
        const storageKey = `history_${currentUser}`; // 使用独立的存储键
        
        // 获取器材类型
        const equipmentType = getUserEquipmentType(deviceVariables.equipment_type, currentUser);
        
        // 创建新记录
        const newRecord = {
          date: date,
          equipment: equipmentType,
          duration: isOngoing ? '进行中' : '0'
        };
        
        // 获取当前用户的现有记录
        const userRecords = JSON.parse(localStorage.getItem(storageKey) || '[]');
        
        // 添加新记录到数组开头
        userRecords.unshift(newRecord);
        
        // 保存回本地存储
        localStorage.setItem(storageKey, JSON.stringify(userRecords));
        
        // 更新显示
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${newRecord.date}</td>
          <td>${newRecord.equipment}</td>
          <td>${newRecord.duration}</td>
        `;
        
        if (historyTableBody.firstChild) {
          historyTableBody.insertBefore(row, historyTableBody.firstChild);
        } else {
          historyTableBody.appendChild(row);
        }
      }
      
      // 更新历史记录行
      function updateHistoryRow(row, isOngoing, useTimeSec) {
        const currentUser = document.getElementById('student-username').value;
        const storageKey = `history_${currentUser}`; // 使用独立的存储键
        const date = row.cells[0].textContent;
        const userRecords = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const recordIndex = userRecords.findIndex(r => r.date === date);
        
        if (recordIndex !== -1) {
          if (isOngoing) {
            userRecords[recordIndex].duration = '进行中';
            row.cells[2].textContent = '进行中';
          } else {
            let prev = parseInt(userRecords[recordIndex].rawSeconds || 0);
            let now = parseInt(useTimeSec || 0);
            if (userRecords[recordIndex].duration !== '进行中') now += prev;
            userRecords[recordIndex].rawSeconds = now;
            userRecords[recordIndex].duration = formatDuration(now);
            row.cells[2].textContent = userRecords[recordIndex].duration;
            
            // 器材类型追加逻辑
            let eq = getUserEquipmentType(deviceVariables.equipment_type, currentUser);
            let eqs = userRecords[recordIndex].equipment.split(',');
            if(!eqs.includes(eq)) {
              userRecords[recordIndex].equipment += ',' + eq;
              row.cells[1].textContent = userRecords[recordIndex].equipment;
            }
          }
          
          // 保存回本地存储
          localStorage.setItem(storageKey, JSON.stringify(userRecords));
        }
      }
      
      // 添加按钮点击波纹效果
      function addRippleEffect() {
        document.querySelectorAll('button').forEach(button => {
          button.addEventListener('click', function(e) {
            const rect = button.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const ripple = document.createElement('span');
            ripple.classList.add('ripple-effect');
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            
            button.appendChild(ripple);
            
            setTimeout(() => {
              ripple.remove();
            }, 600);
          });
        });
      }
      
      // 设置门按钮样式
      function setupDoorButtons() {
        const doorButtons = document.querySelectorAll('.door-btn');
        doorButtons.forEach(btn => {
          btn.style.width = '120px';
          if (btn.id !== 'door2-toggle') {
            btn.style.marginRight = '10px';
          }
        });
      }
      
      // 存储用户名和姓名的映射
      const userNameMap = {
        '175905': '徐如玉',
        '210797': '葛科元',
        '175908': '张博祯'
      };
      
      // OneNet物联网平台API配置
      const config = {
        productId: '56i5KnK1KX',
        deviceName: 'ch32',
        authorization: 'version=2018-10-31&res=products%2F56i5KnK1KX%2Fdevices%2Fch32&et=1767233340&method=md5&sign=xTIiV6aZQvvpq1yJti58tQ%3D%3D',
        queryApiUrl: 'https://iot-api.heclouds.com/thingmodel/query-device-property',
        setApiUrl: 'https://iot-api.heclouds.com/thingmodel/set-device-desired-property'
      };
      
      // 辅助函数
      function convertToBoolean(value) {
        if (typeof value === 'boolean') return value;
        if (value === 'true' || value === '1' || value === 1) return true;
        if (value === 'false' || value === '0' || value === 0) return false;
        return Boolean(value);
      }
      
      function getCurrentDateString() {
        const today = new Date();
        return today.getFullYear() + '-' + 
               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
               String(today.getDate()).padStart(2, '0');
      }
      
      function formatDate(year, month, day) {
        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      }
      
      // 生成最近两个月内的随机日期
      function generateRecentDate(daysAgo) {
        const today = new Date();
        const pastDate = new Date(today);
        pastDate.setDate(today.getDate() - daysAgo);
        
        const year = pastDate.getFullYear();
        const month = String(pastDate.getMonth() + 1).padStart(2, '0');
        const day = String(pastDate.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
      }
      
      // 更新表格中的日期为最近两个月内的日期
      const dateCells = document.querySelectorAll('#exception-table-body tr td:nth-child(3)');
      dateCells.forEach((cell, index) => {
        // 根据索引生成不同的日期，确保日期分布在最近两个月内
        const daysAgo = 5 + (index * 7); // 5, 12, 19, 26, 33, 40, 47, 54天前
        cell.textContent = generateRecentDate(daysAgo);
      });
      
      // 绑定状态单元格点击事件
      document.querySelectorAll('.status-cell').forEach(cell => {
        cell.addEventListener('click', function() {
          const currentStatus = this.getAttribute('data-status');
          const newStatus = currentStatus === 'done' ? 'pending' : 'done';
          
          // 更新状态文本和属性
          this.setAttribute('data-status', newStatus);
          this.textContent = newStatus === 'done' ? '已处理' : '未处理';
          
          // 确保颜色样式正确应用
          if (newStatus === 'pending') {
            this.style.color = '#dc3545';
            this.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
          } else {
            this.style.color = '#28a745';
            this.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
          }
        });
      });
      
      // 添加实时监控数据的显示/隐藏功能
      const toggleMonitorBtn = document.getElementById('toggle-monitor-data');
      if (toggleMonitorBtn) {
        // 移除箭头图标
        const svgElement = toggleMonitorBtn.querySelector('svg');
        if (svgElement) {
          svgElement.remove();
        }
        
        toggleMonitorBtn.addEventListener('click', function() {
          const contentDiv = document.getElementById('monitor-data-content');
          const toggleText = document.getElementById('toggle-text');
          
          if (contentDiv.style.display === 'none') {
            contentDiv.style.display = 'flex';
            toggleText.textContent = '';
          } else {
            contentDiv.style.display = 'none';
            toggleText.textContent = '';
          }
        });
      }
      
      // 界面切换事件
      document.querySelectorAll('.menu-btn').forEach(button => {
        button.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          const dashboard = this.closest('.card');
          
          dashboard.querySelectorAll('.tab-panel').forEach(panel => {
            panel.style.display = 'none';
          });
          
          if(targetId) {
            document.getElementById(targetId).style.display = 'block';
            
            if(targetId === 'teacher-door') {
              queryDeviceStatus();
            } else if(targetId === 'student-qrcode') {
              loadStudentQRCode();
            } else if(targetId === 'teacher-qrcode') {
              loadTeacherQRCode();
            } else if(targetId === 'teacher-exception') {
              setTimeout(() => {
                fetchDeviceVariables();
              }, 100);
            } else if(targetId === 'student-history') {
              document.getElementById('student-history').style.display = 'block';
              fetchDeviceVariables();
            }
          }
        });
      });
      
      // 设备状态查询
      const deviceStatusInterval = setInterval(fetchDeviceVariables, 1000);
      fetchDeviceVariables();
      
      // 根据账号和use_flag获取对应的使用状态
      function getUserUseFlag(use_flag, account) {
        console.log('当前use_flag值:', use_flag); // 添加调试日志
        console.log('当前账号:', account); // 添加调试日志
        
        let digit = 0;
        // 确保use_flag是数字类型
        use_flag = parseInt(use_flag);
        
        switch(account) {
          case '210797':
            digit = Math.floor(use_flag / 100) % 10; // 获取百位
            console.log('210797账号百位值:', digit); // 添加调试日志
            break;
          case '175905':
            digit = Math.floor((use_flag % 100) / 10); // 获取十位
            console.log('175905账号十位值:', digit); // 添加调试日志
            break;
          case '175908':
            digit = use_flag % 10; // 获取个位
            console.log('175908账号个位值:', digit); // 添加调试日志
            break;
        }
        const result = digit === 1;
        console.log(`账号 ${account} 的状态计算结果:`, result);
        return result;
      }

      // 根据账号和equipment_type获取对应的器材类型（教师界面使用）
      function getUserEquipmentType(equipment_type, error_flag) {
        console.log('当前equipment_type值:', equipment_type); 
        console.log('当前错误标志:', error_flag); 
        
        let digit = 0;
        // 确保equipment_type是数字类型
        equipment_type = parseInt(equipment_type);
        
        // 根据错误标志选择不同的位数
        switch(error_flag) {
          case '210797':
            digit = Math.floor(equipment_type / 100) % 10; // 获取百位
            console.log('210797账号百位值:', digit);
            break;
          case '175905':
            digit = Math.floor((equipment_type % 100) / 10); // 获取十位
            console.log('175905账号十位值:', digit);
            break;
          case '175908':
            digit = equipment_type % 10; // 获取个位
            console.log('175908账号个位值:', digit);
            break;
          default:
            return '未选择';
        }
        
        // 根据数字返回对应的器材类型
        switch(digit) {
          case 0:
            return '篮球';
          case 1:
            return '跳绳';
          case 2:
            return '乒乓球';
          default:
            return '未选择';
        }
      }

      // 根据账号和equipment_type获取对应的器材类型（学生界面使用）
      function getStudentEquipmentType(equipment_type, account) {
        console.log('学生界面 - 当前equipment_type值:', equipment_type); 
        console.log('学生界面 - 当前账号:', account); 
        
        let digit = 0;
        // 确保equipment_type是数字类型
        equipment_type = parseInt(equipment_type);
        
        // 根据账号选择不同的位数
        switch(account) {
          case '210797':
            digit = Math.floor(equipment_type / 100) % 10; // 获取百位
            console.log('210797账号百位值:', digit);
            break;
          case '175905':
            digit = Math.floor((equipment_type % 100) / 10); // 获取十位
            console.log('175905账号十位值:', digit);
            break;
          case '175908':
            digit = equipment_type % 10; // 获取个位
            console.log('175908账号个位值:', digit);
            break;
          default:
            return '未选择';
        }
        
        // 根据数字返回对应的器材类型
        switch(digit) {
          case 0:
            return '篮球';
          case 1:
            return '跳绳';
          case 2:
            return '乒乓球';
          default:
            return '未选择';
        }
      }

      // 从OneNet API获取设备变量
      async function fetchDeviceVariables() {
        try {
          const apiUrl = `${config.queryApiUrl}?product_id=${encodeURIComponent(config.productId)}&device_name=${encodeURIComponent(config.deviceName)}`;
          
          const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': config.authorization
            }
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.code === 0 && data.data) {
            let properties = [];
            let rawPropertiesData = '无属性数据';
            
            if (data.data && data.data.list) {
              properties = data.data.list;
              rawPropertiesData = JSON.stringify(data.data.list, null, 2);
            } else if (Array.isArray(data.data)) {
              properties = data.data;
              rawPropertiesData = JSON.stringify(data.data, null, 2);
            }
            
            console.log('API返回的原始数据:', data);
            console.log('解析的属性列表:', properties);
            
            // 保存之前的use_flag状态
            const oldUseFlag = deviceVariables.use_flag;
            const oldErrorFlag = deviceVariables.错误标志;
            
            const useFlagProperty = properties.find(prop => prop.identifier === 'use_flag');
            const equipmentTypeProperty = properties.find(prop => prop.identifier === 'equipment_type');
            const errorFlagProperty = properties.find(prop => prop.identifier === '错误标志');
            const cabinetProperty = properties.find(prop => prop.identifier === 'cabinet');
            const lock1Property = properties.find(prop => prop.identifier === 'Lock1');
            const lock2Property = properties.find(prop => prop.identifier === 'Lock2');
            
            if (useFlagProperty) {
              // 确保use_flag是整数
              deviceVariables.use_flag = parseInt(useFlagProperty.value) || 0;
              console.log('解析到的use_flag值:', deviceVariables.use_flag);
              
              // 处理所有账号的状态变化
              const accounts = ['210797', '175905', '175908'];
              accounts.forEach(account => {
                const oldStatus = getUserUseFlag(oldUseFlag, account);
                const newStatus = getUserUseFlag(deviceVariables.use_flag, account);
                console.log(`账号 ${account} 状态变化:`, oldStatus, '->', newStatus);
                
                if (oldStatus === false && newStatus === true) {
                  console.log(`开始计时 - 账号: ${account}`);
                  startTimer(account);
                } else if (oldStatus === true && newStatus === false) {
                  console.log(`停止计时 - 账号: ${account}`);
                  const useTime = stopTimer(account);
                  console.log(`使用时长 - 账号: ${account}, 时长: ${useTime}秒`);
                  updateHistoryWithTime(account, useTime);
                }
              });
              
              // 更新使用状态显示
              const useFlagDisplay = document.getElementById('current-use-flag');
              if (useFlagDisplay) {
                const currentUser = document.getElementById('student-username').value;
                const isUsing = getUserUseFlag(deviceVariables.use_flag, currentUser);
                useFlagDisplay.textContent = isUsing.toString();
                
                if (isUsing) {
                  useFlagDisplay.style.color = '#28a745';
                  useFlagDisplay.style.backgroundColor = '#e5f9ee';
                } else {
                  useFlagDisplay.style.color = '#007bff';
                  useFlagDisplay.style.backgroundColor = '#e9f5ff';
                }
              }
            }
            
            if (equipmentTypeProperty) {
              deviceVariables.equipment_type = parseInt(equipmentTypeProperty.value) || 0;
              console.log('解析到的equipment_type值:', deviceVariables.equipment_type);
              
              // 更新器材类型显示
              const equipmentTypeDisplay = document.getElementById('current-student-equipment-type');
              if (equipmentTypeDisplay) {
                // 获取当前用户账号
                const currentUser = document.getElementById('student-username').value;
                
                // 根据当前用户账号获取对应的器材类型
                const equipmentName = getStudentEquipmentType(deviceVariables.equipment_type, currentUser);
                console.log('计算得到的器材类型:', equipmentName);
                
                equipmentTypeDisplay.textContent = equipmentName;
              }
              
              const equipmentTypeDisplay2 = document.getElementById('current-equipment-type');
              if (equipmentTypeDisplay2) {
                // 获取当前错误标志
                const currentErrorFlag = deviceVariables.错误标志.toString();
                
                // 根据当前错误标志获取对应的器材类型
                const equipmentName = getUserEquipmentType(deviceVariables.equipment_type, currentErrorFlag);
                equipmentTypeDisplay2.textContent = equipmentName;
              }
            }
            
            if (errorFlagProperty) {
              deviceVariables.错误标志 = parseInt(errorFlagProperty.value) || 0;
              
              // 更新错误标志显示
              const errorFlagDisplay = document.getElementById('current-error-flag');
              if (errorFlagDisplay) {
                errorFlagDisplay.textContent = deviceVariables.错误标志;
              }
              
              // 添加调试日志
              console.log('错误标志属性:', errorFlagProperty);
              console.log('错误标志值:', errorFlagProperty.value, '转换后:', deviceVariables.错误标志);
            } else {
              // 尝试使用其他可能的标识符查找错误标志
              let foundErrorProperty = null;
              const possibleIdentifiers = ['错误标记', 'error_flag', 'errorFlag', 'error', 'flag', 'ErrorFlag', 'ErrorCode'];
              
              for (const identifier of possibleIdentifiers) {
                const prop = properties.find(p => p.identifier === identifier);
                if (prop) {
                  foundErrorProperty = prop;
                  console.log(`找到可能的错误标志属性: ${identifier}`, prop);
                  break;
                }
              }
              
              // 尝试直接查找是否有属性的值匹配我们期望的error_flag值
              const targetAccountNumbers = [175905, 210797, 175908];
              if (!foundErrorProperty) {
                for (const prop of properties) {
                  const numValue = typeof prop.value === 'number' ? prop.value : 
                                  parseInt(String(prop.value).trim());
                  
                  if (!isNaN(numValue) && targetAccountNumbers.includes(numValue)) {
                    console.log(`找到值匹配的属性! 属性: ${prop.identifier}, 值: ${numValue}`);
                    foundErrorProperty = prop;
                    break;
                  }
                }
              }
              
              // 如果上述标识符都不匹配，尝试模糊匹配
              if (!foundErrorProperty) {
                foundErrorProperty = properties.find(p => 
                  p.identifier.includes('error') || 
                  p.identifier.includes('flag') || 
                  p.identifier.includes('错误') ||
                  (typeof p.value === 'number' && p.value > 100000)  // 假设错误标志是大于10万的数字
                );
                
                if (foundErrorProperty) {
                  console.log('通过模糊匹配找到可能的错误标志:', foundErrorProperty);
                }
              }
              
              // 调试输出所有属性
              console.log('所有设备属性:');
              properties.forEach(prop => {
                console.log(`${prop.identifier}: ${prop.value} (类型: ${typeof prop.value})`);
              });
              
              if (foundErrorProperty) {
                // 尝试不同的方式解析错误标志值
                let errorValue = 0;
                if (typeof foundErrorProperty.value === 'string') {
                  errorValue = parseInt(foundErrorProperty.value) || 0;
                } else if (typeof foundErrorProperty.value === 'number') {
                  errorValue = foundErrorProperty.value;
                } else {
                  errorValue = Number(foundErrorProperty.value) || 0;
                }
                
                deviceVariables.错误标志 = errorValue;
                console.log(`解析到错误标志值: ${errorValue}`);
                
                // 更新错误标志显示
                const errorFlagDisplay = document.getElementById('current-error-flag');
                if (errorFlagDisplay) {
                  errorFlagDisplay.textContent = deviceVariables.错误标志;
                }
              } else {
                console.warn('未找到合适的错误标志属性');
                
                // 在调试信息中显示所有属性
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) {
                  debugInfo.textContent += '\n\n未找到错误标志属性，所有可用属性:\n' + 
                    properties.map(p => `${p.identifier}: ${p.value} (${typeof p.value})`).join('\n');
                }
              }
            }
            
            if (cabinetProperty) {
              deviceVariables.cabinet = parseInt(cabinetProperty.value) || 0;
              
              // 更新柜子号显示
              const cabinetDisplay = document.getElementById('current-cabinet');
              if (cabinetDisplay) {
                cabinetDisplay.textContent = deviceVariables.cabinet;
              }
            }
            
            if (lock1Property) {
              deviceVariables.Lock1 = convertToBoolean(lock1Property.value);
              updateLockDisplay(1, deviceVariables.Lock1);
            }
            
            if (lock2Property) {
              deviceVariables.Lock2 = convertToBoolean(lock2Property.value);
              updateLockDisplay(2, deviceVariables.Lock2);
            }
            
            // 检查错误标志变化并添加记录
            if (oldErrorFlag !== deviceVariables.错误标志 && deviceVariables.错误标志 !== 0) {
              const errorId = deviceVariables.错误标志.toString();
              // 只处理特定的错误ID
              if (errorId === '210797' || errorId === '175905' || errorId === '175908') {
                addExceptionRecord(errorId);
              }
            }
            
            // 检查use_flag的变化并更新历史记录
            const currentDateStr = getCurrentDateString();
            const historyTableBody = document.getElementById('history-table-body');
            
            if (historyTableBody) {
              const currentUser = document.getElementById('student-username').value;
              const oldIsUsing = getUserUseFlag(oldUseFlag, currentUser);
              const newIsUsing = getUserUseFlag(deviceVariables.use_flag, currentUser);
              
              // 当use_flag从false变为true时添加或更新记录
              if (oldIsUsing === false && newIsUsing === true) {
                console.log('检测到使用状态变化: false -> true，更新历史记录');
                const existingTodayRow = findTodayRow(historyTableBody, currentDateStr);
                
                if (existingTodayRow) {
                  // 如果今天已有记录，则更新该记录
                  updateHistoryRow(existingTodayRow, true, window.timerCurrent['210797']);
                } else {
                  // 否则创建新记录
                  insertNewHistoryRecord(currentDateStr, true);
                }
              }
              // 当use_flag从true变为false时替换"进行中"为实际使用时长
              else if (oldIsUsing === true && newIsUsing === false) {
                console.log('检测到使用状态变化: true -> false，更新使用时长');
                const existingTodayRow = findTodayRow(historyTableBody, currentDateStr);
                
                if (existingTodayRow) {
                  // 更新使用时长
                  updateHistoryRow(existingTodayRow, false, window.timerCurrent['210797']);
                }
              }
            }
            
            // 保存当前状态用于下次比较
            previousUseFlag = deviceVariables.use_flag;
            
            return true;
          } else {
            console.error('设备状态查询失败:', data.msg || '未知错误');
            return false;
          }
        } catch (error) {
          console.error('获取设备状态失败:', error);
          document.getElementById('lock1-status').textContent = '门1状态: 查询出错';
          document.getElementById('lock2-status').textContent = '门2状态: 查询出错';
          return false;
        }
      }
      
      // 添加异常记录函数
      function addExceptionRecord(errorId) {
        const exceptionTableBody = document.getElementById('exception-table-body');
        if (!exceptionTableBody) return;
        
        // 获取用户信息
        const userName = userNameMap[errorId] || '未知用户';
        
        // 获取当前日期
        const today = getCurrentDateString();
        
        // 检查是否已存在相同学生的当天记录
        const existingRecords = getExceptionRecords();
        const hasDuplicateRecord = existingRecords.some(record => 
          record.accountId === errorId && record.date === today
        );
        
        if (hasDuplicateRecord) {
          console.log('今天已存在该学生的异常记录，跳过添加');
          return;
        }
        
        // 获取柜子编号
        const cabinetNumber = deviceVariables.cabinet || 1;
        
        // 获取器材类型
        const equipmentName = getUserEquipmentType(deviceVariables.equipment_type, errorId);
        
        // 创建新记录对象
        const newRecord = {
          accountId: errorId,
          userName: userName,
          date: today,
          cabinet: cabinetNumber,
          equipment: equipmentName,
          status: '未处理',
          timestamp: Date.now() // 添加时间戳用于排序
        };
        
        // 保存到本地存储
        saveExceptionRecord(newRecord);
        
        // 更新显示
        updateExceptionTableDisplay();
      }
      
      // 初始化异常记录存储
      function initExceptionStorage() {
        if (!localStorage.getItem('exceptionRecords')) {
          localStorage.setItem('exceptionRecords', JSON.stringify([]));
        }
        // 教师登录成功时加载异常记录
        if (document.getElementById('teacher-exception')) {
          updateExceptionTableDisplay();
        }
      }
      
      // 获取所有异常记录
      function getExceptionRecords() {
        const records = localStorage.getItem('exceptionRecords');
        return records ? JSON.parse(records) : [];
      }
      
      // 保存异常记录
      function saveExceptionRecord(record) {
        const records = getExceptionRecords();
        records.push(record);
        localStorage.setItem('exceptionRecords', JSON.stringify(records));
      }
      
      // 更新异常记录状态
      function updateExceptionStatus(accountId, date, newStatus) {
        const records = getExceptionRecords();
        const recordIndex = records.findIndex(r => r.accountId === accountId && r.date === date);
        
        if (recordIndex !== -1) {
          records[recordIndex].status = newStatus;
          localStorage.setItem('exceptionRecords', JSON.stringify(records));
          updateExceptionTableDisplay();
        }
      }
      
      // 更新异常记录表格显示
      function updateExceptionTableDisplay() {
        const exceptionTableBody = document.getElementById('exception-table-body');
        if (!exceptionTableBody) return;
        
        // 获取并按时间戳倒序排序记录
        let records = getExceptionRecords().filter(r=>r.accountId&&r.accountId!=='undefined');
        // 自动清理脏数据
        if(records.length!==getExceptionRecords().length)
          localStorage.setItem('exceptionRecords',JSON.stringify(records));
        records = records.sort((a, b) => b.timestamp - a.timestamp);
        
        // 清空现有表格内容
        exceptionTableBody.innerHTML = '';
        
        // 添加所有记录
        records.forEach(record => {
          const row = document.createElement('tr');
          let statusColor = record.status === '未处理' ? 'color:#dc3545;background:#fae8ea;' : 'color:#28a745;background:#e5f9ee;';
          row.innerHTML = `
            <td><input type='checkbox' class='exception-select' data-id='${record.accountId}' data-date='${record.date}'></td>
            <td>${record.accountId}</td>
            <td>${record.date}</td>
            <td>${record.cabinet}</td>
            <td>${record.equipment}</td>
            <td class="status-cell" data-status="${record.status === '未处理' ? 'pending' : 'processed'}" style="${statusColor}font-weight:600;border-radius:18px;padding:4px 16px;box-shadow:0 2px 8px #28a74522;">${record.status}</td>
          `;
          // 为状态单元格添加点击事件
          const statusCell = row.querySelector('.status-cell');
          statusCell.addEventListener('click', () => {
            const newStatus = record.status === '未处理' ? '已处理' : '未处理';
            updateExceptionStatus(record.accountId, record.date, newStatus);
          });
          exceptionTableBody.appendChild(row);
        });
        // 全选功能
        const allBox=document.getElementById('exception-select-all');
        if(allBox){
          allBox.onclick=()=>{
            document.querySelectorAll('.exception-select').forEach(c=>c.checked=allBox.checked);
          };
        }
        // 删除按钮事件绑定
        const delBtn=document.getElementById('delete-exception-btn');
        if(delBtn)delBtn.onclick=function(){
          let sel=document.querySelectorAll('.exception-select:checked');
          if(!sel.length)return alert('请先选择要删除的记录');
          if(!confirm('确定要删除选中记录吗？'))return;
          let records=getExceptionRecords();
          sel.forEach(box=>{
            let id=box.getAttribute('data-id'),date=box.getAttribute('data-date');
            let idx=records.findIndex(r=>r.accountId==id&&r.date==date);
            if(idx>-1)records.splice(idx,1);
          });
          localStorage.setItem('exceptionRecords',JSON.stringify(records));
          updateExceptionTableDisplay();
        };
      }
      
      // 历史记录相关函数
      function findTodayRow(tableBody, dateStr) {
        for (let i = 0; i < tableBody.rows.length; i++) {
          const row = tableBody.rows[i];
          const dateCell = row.cells[0];
          if (dateCell && dateCell.textContent === dateStr) {
            return row;
          }
        }
        return null;
      }
      
      // 登录切换和验证
      document.getElementById('student-tab').addEventListener('click', () => toggleLoginPanels('student'));
      document.getElementById('teacher-tab').addEventListener('click', () => toggleLoginPanels('teacher'));
      
      function toggleLoginPanels(userType) {
        const isStudent = userType === 'student';
        
        // 添加动画
        const oldPanel = isStudent ? document.getElementById('teacher-login') : document.getElementById('student-login');
        const newPanel = isStudent ? document.getElementById('student-login') : document.getElementById('teacher-login');
        
        oldPanel.style.animation = 'fadeOut 0.3s ease forwards';
        
        setTimeout(() => {
          document.getElementById('student-login').classList.toggle('hidden', !isStudent);
          document.getElementById('teacher-login').classList.toggle('hidden', isStudent);
          document.getElementById('student-tab').classList.toggle('active', isStudent);
          document.getElementById('teacher-tab').classList.toggle('active', !isStudent);
          
          newPanel.style.animation = 'fadeIn 0.3s ease';
        }, 300);
      }
      
      let currentLogin = {
        student: { username: '210797', password: '210797' },
        teacher: { username: '359921', password: '359921' }
      };
      
      document.getElementById('student-login-btn').addEventListener('click', (e) => {
        addLoginButtonEffect(e.currentTarget);
        setTimeout(() => login('student'), 300);
      });
      
      document.getElementById('teacher-login-btn').addEventListener('click', (e) => {
        addLoginButtonEffect(e.currentTarget);
        setTimeout(() => login('teacher'), 300);
      });
      
      function addLoginButtonEffect(button) {
        button.classList.add('login-btn-clicked');
        setTimeout(() => {
          button.classList.remove('login-btn-clicked');
        }, 300);
      }
      
      function login(userType) {
        const usernameInput = document.getElementById(userType + '-username');
        const passwordInput = document.getElementById(userType + '-password');
        const username = usernameInput.value;
        const password = passwordInput.value;
        
        const credentials = {
          student: {username: '210797', password: '210797'},
          teacher: {username: '359921', password: '359921'},
          '175905': {type: 'student', password: '175905'},
          '175908': {type: 'student', password: '175908'}
        };
        
        let loginSuccess = false;
        let dashboardType = '';
        
        // 重置之前的计时器
        if (window.timerInterval && window.timerInterval[username]) {
          clearInterval(window.timerInterval[username]);
          window.timerInterval[username] = null;
        }
        
        if (userType === 'student') {
          // 检查是否是其他学生账号（175905或175908）
          if ((username === '175905' && password === '175905') || 
              (username === '175908' && password === '175908')) {
            loginSuccess = true;
            dashboardType = 'student';
            currentLogin.student = { username, password };
          }
          // 检查是否是210797账号
          else if (username === credentials.student.username && 
                   password === credentials.student.password) {
            loginSuccess = true;
            dashboardType = 'student';
            currentLogin.student = { username, password };
          }
        } 
        else if (userType === 'teacher' && 
                 username === credentials.teacher.username && 
                 password === credentials.teacher.password) {
          loginSuccess = true;
          dashboardType = 'teacher';
          currentLogin.teacher = { username, password };
        }
        
        if (loginSuccess) {
          // 更新student-username输入框的值为当前登录的账号
          document.getElementById('student-username').value = username;
          console.log('登录成功，当前用户名设置为:', username); // 添加调试日志
          
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById(dashboardType + '-dashboard').classList.remove('hidden');
          
          const firstMenuBtn = document.querySelector('#' + dashboardType + '-dashboard .menu-btn');
          if (firstMenuBtn) {
            firstMenuBtn.click();
          }
          
          // 重新生成历史记录
          if (dashboardType === 'student') {
            generateInitialHistoryRecords();
          }
        } else {
          alert(userType === 'student' ? '学生账号或密码错误!' : '教师账号或密码错误!');
        }
      }

      document.getElementById('student-logout').addEventListener('click', () => logout('student'));
      document.getElementById('teacher-logout').addEventListener('click', () => logout('teacher'));
      
      function logout(userType) {
        // 清除当前用户的计时器
        const currentUser = document.getElementById('student-username').value;
        if (window.timerInterval && window.timerInterval[currentUser]) {
          clearInterval(window.timerInterval[currentUser]);
          window.timerInterval[currentUser] = null;
        }
        
        document.getElementById(userType + '-dashboard').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
        
        if (userType === 'student') {
          document.getElementById('student-tab').click();
          // 重置为默认账号
          document.getElementById('student-username').value = '210797';
          document.getElementById('student-password').value = '210797';
        } else {
          document.getElementById('teacher-tab').click();
          document.getElementById('teacher-username').value = currentLogin.teacher.username;
          document.getElementById('teacher-password').value = currentLogin.teacher.password;
        }
        
        console.log('退出登录，重置为默认账号'); // 添加调试日志
      }

      // 设备状态和控制
      let deviceStatus = {
        isLocked1: true,
        isLocked2: true,
        lastUpdateTime1: '',
        lastUpdateTime2: ''
      };
      
      async function queryDeviceStatus() {
        try {
          const url = `${config.queryApiUrl}?product_id=${encodeURIComponent(config.productId)}&device_name=${encodeURIComponent(config.deviceName)}`;
          
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': config.authorization
            }
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.code === 0 && data.data) {
            let properties = [];
            
            if (data.data && data.data.list) {
              properties = data.data.list;
            } else if (Array.isArray(data.data)) {
              properties = data.data;
            }
            
            const currentTime = new Date().toLocaleString();
            
            const lock1Property = properties.find(prop => prop.identifier === 'Lock1');
            const lock2Property = properties.find(prop => prop.identifier === 'Lock2');
            
            if (lock1Property) {
              deviceStatus.isLocked1 = convertToBoolean(lock1Property.value);
              deviceStatus.lastUpdateTime1 = currentTime;
              updateLockDisplay(1, deviceStatus.isLocked1, deviceStatus.lastUpdateTime1);
            }
            
            if (lock2Property) {
              deviceStatus.isLocked2 = convertToBoolean(lock2Property.value);
              deviceStatus.lastUpdateTime2 = currentTime;
              updateLockDisplay(2, deviceStatus.isLocked2, deviceStatus.lastUpdateTime2);
            }
            
            return true;
          } else {
            throw new Error(data.error || data.msg || '查询失败');
          }
        } catch (error) {
          console.error('查询设备状态失败:', error);
          document.getElementById('lock1-status').textContent = '门1状态: 查询出错';
          document.getElementById('lock2-status').textContent = '门2状态: 查询出错';
          return false;
        }
      }
      
      async function setDeviceLockStatus(lockNumber, isLocked) {
        try {
          const doorToggleBtn = document.getElementById(`door${lockNumber}-toggle`);
          if (doorToggleBtn) doorToggleBtn.disabled = true;
          
          const requestData = {
            product_id: config.productId,
            device_name: config.deviceName,
            params: { [`Lock${lockNumber}`]: isLocked }
          };
          
          const response = await fetch(config.setApiUrl, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'Authorization': config.authorization
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.errno === 0 || data.code === 0) {
            deviceStatus[`isLocked${lockNumber}`] = isLocked;
            const currentTime = new Date().toLocaleString();
            deviceStatus[`lastUpdateTime${lockNumber}`] = currentTime;
            
            updateLockDisplay(lockNumber, isLocked, currentTime);
            
            setTimeout(() => queryDeviceStatus(), 2000);
            
            return true;
          } else {
            throw new Error(data.error || data.msg || '设置失败');
          }
        } catch (error) {
          console.error(`设置门锁${lockNumber}状态失败:`, error);
          document.getElementById(`lock${lockNumber}-status`).textContent = `门${lockNumber}状态: 设置失败`;
          return false;
        } finally {
          const doorToggleBtn = document.getElementById(`door${lockNumber}-toggle`);
          if (doorToggleBtn) doorToggleBtn.disabled = false;
        }
      }
      
      
      document.getElementById('door2-toggle').addEventListener('click', async () => {
        const currentLockStatus = deviceVariables.Lock2 || deviceStatus.isLocked2;
        const newLockStatus = !currentLockStatus;
        await setDeviceLockStatus(2, newLockStatus);
      });
      
      // 二维码加载
      function loadStudentQRCode() {
        let u=document.getElementById('student-username').value||'210797',c=document.getElementById('qrcode-image');c.innerHTML='';new QRCode(c,{text:u,width:200,height:200});
      }

      function loadTeacherQRCode() {
        let u=document.getElementById('teacher-username').value||'359921',c=document.getElementById('teacher-qrcode-image');c.innerHTML='';new QRCode(c,{text:u,width:200,height:200});
      }

      // 更新门锁状态显示
      function updateLockDisplay(lockNumber, isLocked, updateTime) {
        const lockStatusElement = document.getElementById(`lock${lockNumber}-status`);
        if (lockStatusElement) {
          lockStatusElement.textContent = `门${lockNumber}状态: ${isLocked ? '已关门' : '已开门'}`;
        }
        
        const updateTimeElement = document.getElementById(`lock${lockNumber}-update-time`);
        if (updateTimeElement && updateTime) {
          updateTimeElement.textContent = `最后更新时间: ${updateTime}`;
        }
        
        const doorToggleBtn = document.getElementById(`door${lockNumber}-toggle`);
        if (doorToggleBtn) {
          doorToggleBtn.textContent = isLocked ? '已关门' : '已开门';
          doorToggleBtn.classList.remove('door-open', 'door-closed');
          doorToggleBtn.classList.add(isLocked ? 'door-closed' : 'door-open');
        }
        
        deviceStatus[`isLocked${lockNumber}`] = isLocked;
      }

      // 添加样式和交互
      const styleElement = document.createElement('style');
      styleElement.textContent = `
        .ripple-effect {
          position: absolute;
          border-radius: 50%;
          background-color: rgba(255, 255, 255, 0.5);
          width: 100px;
          height: 100px;
          margin-top: -50px;
          margin-left: -50px;
          animation: ripple-animation 0.6s ease-out;
          pointer-events: none;
        }
        
        @keyframes ripple-animation {
          0% {
            transform: scale(0);
            opacity: 0.5;
          }
          100% {
            transform: scale(2);
            opacity: 0;
          }
        }
        
        .theme-transition {
          animation: theme-rotate 0.3s ease;
        }
        
        @keyframes theme-rotate {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeOut {
          from { opacity: 1; }
          to { opacity: 0; }
        }
        
        .login-btn-clicked {
          transform: scale(0.95);
          opacity: 0.9;
        }
        
        .menu-btn {
          position: relative;
          overflow: hidden;
          transition: all 0.3s ease;
        }
        
        .menu-btn:hover {
          transform: translateY(-3px);
          box-shadow: 0 6px 12px rgba(0, 123, 255, 0.3);
        }
        
        #qrcode-image, #teacher-qrcode-image {
          transition: transform 0.3s ease;
        }
        
        #qrcode-image:hover, #teacher-qrcode-image:hover {
          transform: scale(1.05);
        }
        
        .login-panel input:focus + label,
        .login-panel input:valid + label {
          transform: translateY(-25px);
          font-size: 14px;
          color: var(--primary-color);
        }
        
        /* 默认隐藏选择相关元素 */
        .exception-select, #exception-select-all, #delete-exception-btn, 
        #teacher-exception th:first-child, #teacher-exception td:first-child {
          display: none !important;
        }
        
        /* 选择模式时显示 */
        .show-select .exception-select, 
        .show-select #exception-select-all, 
        .show-select #delete-exception-btn,
        .show-select #teacher-exception th:first-child,
        .show-select #teacher-exception td:first-child {
          display: table-cell !important;
        }
        
        .show-select #delete-exception-btn {
          display: block !important;
          position: fixed;
          bottom: 20px;
          right: 20px;
          z-index: 1000;
          border-radius: 50px;
          padding: 12px 24px;
          box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
          animation: fadeIn 0.3s ease;
        }
      `;
      document.head.appendChild(styleElement);

      // 测试use_flag逻辑
      function testUseFlagLogic() {
        console.log('=== 测试use_flag逻辑 ===');
        const testCases = [
          { use_flag: 100, account: '210797', expected: true },
          { use_flag: 0, account: '210797', expected: false },
          { use_flag: 10, account: '175905', expected: true },
          { use_flag: 0, account: '175905', expected: false },
          { use_flag: 1, account: '175908', expected: true },
          { use_flag: 0, account: '175908', expected: false },
          { use_flag: 111, account: '210797', expected: true },
          { use_flag: 111, account: '175905', expected: true },
          { use_flag: 111, account: '175908', expected: true }
        ];

        testCases.forEach(test => {
          const result = getUserUseFlag(test.use_flag, test.account);
          console.log(`测试: use_flag=${test.use_flag}, account=${test.account}`);
          console.log(`期望结果: ${test.expected}, 实际结果: ${result}`);
          console.log(`测试${result === test.expected ? '通过' : '失败'}`);
        });
      }

      // 添加测试函数
      function testEquipmentTypeLogic() {
        console.log('=== 测试equipment_type逻辑 ===');
        const testCases = [
          { equipment_type: 0, account: '210797', expected: '篮球' },
          { equipment_type: 100, account: '210797', expected: '跳绳' },
          { equipment_type: 200, account: '210797', expected: '乒乓球' },
          { equipment_type: 300, account: '210797', expected: '未选择' },
          { equipment_type: 0, account: '175905', expected: '篮球' },
          { equipment_type: 10, account: '175905', expected: '跳绳' },
          { equipment_type: 20, account: '175905', expected: '乒乓球' },
          { equipment_type: 30, account: '175905', expected: '未选择' },
          { equipment_type: 0, account: '175908', expected: '篮球' },
          { equipment_type: 1, account: '175908', expected: '跳绳' },
          { equipment_type: 2, account: '175908', expected: '乒乓球' },
          { equipment_type: 3, account: '175908', expected: '未选择' },
          { equipment_type: 111, account: '210797', expected: '跳绳' },
          { equipment_type: 111, account: '175905', expected: '跳绳' },
          { equipment_type: 111, account: '175908', expected: '跳绳' }
        ];

        testCases.forEach(test => {
          const result = getUserEquipmentType(test.equipment_type, test.account);
          console.log(`测试: equipment_type=${test.equipment_type}, account=${test.account}`);
          console.log(`期望结果: ${test.expected}, 实际结果: ${result}`);
          console.log(`测试${result === test.expected ? '通过' : '失败'}`);
        });
      }

      // 在页面加载完成后运行测试
      document.addEventListener('DOMContentLoaded', function() {
        // 初始化暗黑模式
        initDarkMode();

        // 运行use_flag逻辑测试
        testUseFlagLogic();
        
        // 运行equipment_type逻辑测试
        testEquipmentTypeLogic();

        // ... 其他初始化代码 ...
      });

      // 添加清除历史记录功能
      document.getElementById('clear-history-btn').addEventListener('click', function() {
        if (confirm('确定要清除所有历史记录吗？此操作不可恢复。')) {
          // 获取当前用户
          const currentUser = document.getElementById('student-username').value;
          const storageKey = `history_${currentUser}`;
          
          // 只清除当前用户的历史记录
          localStorage.removeItem(storageKey);
          
          // 清空表格显示
          const historyTableBody = document.getElementById('history-table-body');
          if (historyTableBody) {
            historyTableBody.innerHTML = '';
          }
          
          alert('历史记录已清除');
        }
      });

      // 添加更新历史记录的函数
      function updateHistoryWithTime(account, useTime) {
        console.log(`更新历史记录 - 账号: ${account}, 使用时长: ${useTime}秒`); // 添加调试日志
        
        const currentDateStr = getCurrentDateString();
        const storageKey = `history_${account}`;
        
        // 获取该账号的历史记录
        const userRecords = JSON.parse(localStorage.getItem(storageKey) || '[]');
        console.log(`当前历史记录 - 账号: ${account}`, userRecords); // 添加调试日志
        
        // 查找当天记录
        let recordIndex = userRecords.findIndex(r => r.date === currentDateStr);
        if (recordIndex !== -1) {
          // 如果已有记录，累加使用时长
          const prevDuration = parseInt(userRecords[recordIndex].duration) || 0;
          const newDuration = prevDuration + useTime;
          userRecords[recordIndex].duration = newDuration.toString();
          console.log(`更新现有记录 - 之前时长: ${prevDuration}秒, 新增时长: ${useTime}秒, 总时长: ${newDuration}秒`);
        } else {
          // 创建新记录
          userRecords.unshift({
            date: currentDateStr,
            equipment: getStudentEquipmentType(deviceVariables.equipment_type, account),
            duration: useTime.toString()
          });
          console.log(`创建新记录 - 日期: ${currentDateStr}, 时长: ${useTime}秒`);
        }
        
        // 写回localStorage
        localStorage.setItem(storageKey, JSON.stringify(userRecords));
        console.log(`保存历史记录 - 账号: ${account}`, userRecords);
        
        // 如果当前登录账号等于account，刷新表格
        if(document.getElementById('student-username').value === account) {
          console.log(`刷新显示 - 当前登录账号: ${account}`);
          generateInitialHistoryRecords();
        }
      }

      // 统一PC和移动端的长按选择功能
      let longPressTimer;
      let isSelectionMode = false;
      const exceptionTable = document.getElementById('teacher-exception');
      
      if(exceptionTable) {
        // 长按/鼠标长按开始
        const startLongPress = function(e) {
          if(e.target.closest('tr') && !e.target.closest('td:last-child')) {
            longPressTimer = setTimeout(() => {
              isSelectionMode = true;
              document.querySelector('.container').classList.add('show-select');
              const checkbox = e.target.closest('tr').querySelector('.exception-select');
              if(checkbox) checkbox.checked = true;
            }, 500);
          }
        };
        
        // 长按/鼠标长按结束
        const endLongPress = function() {
          clearTimeout(longPressTimer);
        };
        
        // 移动端事件
        exceptionTable.addEventListener('touchstart', startLongPress, {passive: true});
        exceptionTable.addEventListener('touchend', endLongPress);
        exceptionTable.addEventListener('touchmove', endLongPress);
        
        // PC端事件
        exceptionTable.addEventListener('mousedown', startLongPress);
        exceptionTable.addEventListener('mouseup', endLongPress);
        exceptionTable.addEventListener('mouseleave', endLongPress);
        
        // 点击空白处退出选择模式
        document.addEventListener('click', function(e) {
          if(isSelectionMode && !e.target.closest('tr') && !e.target.closest('#delete-exception-btn')) {
            isSelectionMode = false;
            document.querySelector('.container').classList.remove('show-select');
            document.querySelectorAll('.exception-select').forEach(c => c.checked = false);
            if(document.getElementById('exception-select-all')) {
              document.getElementById('exception-select-all').checked = false;
            }
          }
        });
        
        // 选择模式下的点击处理
        exceptionTable.addEventListener('click', function(e) {
          if(isSelectionMode && e.target.closest('tr') && !e.target.closest('td:last-child')) {
            e.preventDefault();
            const checkbox = e.target.closest('tr').querySelector('.exception-select');
            if(checkbox && e.target !== checkbox) {
              checkbox.checked = !checkbox.checked;
            }
          }
        });
      }

      // ... existing code ...
      // 运行测试用例
      function runTests() {
        console.log('=== 测试equipment_type逻辑 ===');
        // 测试用例
        const equipmentTypeTests = [
          // 学生界面测试用例
          { equipment_type: 0, account: '210797', expected: '篮球', isStudent: true },
          { equipment_type: 100, account: '210797', expected: '跳绳', isStudent: true },
          { equipment_type: 200, account: '210797', expected: '乒乓球', isStudent: true },
          { equipment_type: 300, account: '210797', expected: '未选择', isStudent: true },
          { equipment_type: 0, account: '175905', expected: '篮球', isStudent: true },
          { equipment_type: 10, account: '175905', expected: '跳绳', isStudent: true },
          { equipment_type: 20, account: '175905', expected: '乒乓球', isStudent: true },
          { equipment_type: 30, account: '175905', expected: '未选择', isStudent: true },
          { equipment_type: 0, account: '175908', expected: '篮球', isStudent: true },
          { equipment_type: 1, account: '175908', expected: '跳绳', isStudent: true },
          { equipment_type: 2, account: '175908', expected: '乒乓球', isStudent: true },
          { equipment_type: 3, account: '175908', expected: '未选择', isStudent: true },
          { equipment_type: 111, account: '210797', expected: '跳绳', isStudent: true },
          { equipment_type: 111, account: '175905', expected: '跳绳', isStudent: true },
          { equipment_type: 111, account: '175908', expected: '跳绳', isStudent: true },
          
          // 教师界面测试用例
          { equipment_type: 0, error_flag: '210797', expected: '篮球', isStudent: false },
          { equipment_type: 100, error_flag: '210797', expected: '跳绳', isStudent: false },
          { equipment_type: 200, error_flag: '210797', expected: '乒乓球', isStudent: false },
          { equipment_type: 300, error_flag: '210797', expected: '未选择', isStudent: false },
          { equipment_type: 0, error_flag: '175905', expected: '篮球', isStudent: false },
          { equipment_type: 10, error_flag: '175905', expected: '跳绳', isStudent: false },
          { equipment_type: 20, error_flag: '175905', expected: '乒乓球', isStudent: false },
          { equipment_type: 30, error_flag: '175905', expected: '未选择', isStudent: false },
          { equipment_type: 0, error_flag: '175908', expected: '篮球', isStudent: false },
          { equipment_type: 1, error_flag: '175908', expected: '跳绳', isStudent: false },
          { equipment_type: 2, error_flag: '175908', expected: '乒乓球', isStudent: false },
          { equipment_type: 3, error_flag: '175908', expected: '未选择', isStudent: false }
        ];
        
        let passCount = 0;
        let failCount = 0;
        
        equipmentTypeTests.forEach(test => {
          const result = test.isStudent ? 
            getStudentEquipmentType(test.equipment_type, test.account) :
            getUserEquipmentType(test.equipment_type, test.error_flag);
            
          console.log(`测试: ${test.isStudent ? '学生界面' : '教师界面'}, equipment_type=${test.equipment_type}, ${test.isStudent ? 'account' : 'error_flag'}=${test.isStudent ? test.account : test.error_flag}`);
          console.log(`期望: ${test.expected}, 实际: ${result}`);
          
          if (result === test.expected) {
            console.log('✓ 测试通过');
            passCount++;
          } else {
            console.log('✗ 测试失败');
            failCount++;
          }
          console.log('---');
        });
        
        console.log(`测试完成: ${passCount}个通过, ${failCount}个失败`);
      }
    });

    // ... existing code ...
    // 放在<script>标签内最前面
    function formatDuration(sec){sec=parseInt(sec);if(sec<60)return sec+'秒';return Math.floor(sec/60)+'分'+(sec%60)+'秒';}
    // ... existing code ...
    // 保证generateInitialHistoryRecords结构完整
    function generateInitialHistoryRecords() {
      const historyTableBody = document.getElementById('history-table-body');
      if (!historyTableBody) return;
      
      // 清空现有记录
      historyTableBody.innerHTML = '';
      
      // 获取当前登录的用户账号
      const currentUser = document.getElementById('student-username').value;
      console.log('生成历史记录 - 当前登录账号:', currentUser); // 添加调试日志
      
      // 确保currentUser是有效的账号
      if (!['210797', '175905', '175908'].includes(currentUser)) {
        console.error('无效的用户账号:', currentUser);
        return;
      }
      
      // 从本地存储加载当前用户的历史记录
      const storageKey = `history_${currentUser}`;
      console.log('使用的存储键:', storageKey); // 添加调试日志
      
      const userRecords = JSON.parse(localStorage.getItem(storageKey) || '[]');
      console.log(`加载${currentUser}的历史记录:`, userRecords); // 添加调试日志
      
      // 显示当前用户的记录
      userRecords.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${record.date}</td><td>${record.equipment}</td><td>${isNaN(record.duration)?record.duration:formatDuration(record.duration)}</td>`;
        historyTableBody.appendChild(row);
      });
    }
    // ... existing code ...
    // 保证updateHistoryRow结构完整
    function updateHistoryRow(row, isOngoing, useTimeSec) {
      const currentUser = document.getElementById('student-username').value;
      const storageKey = `history_${currentUser}`; // 使用独立的存储键
      const date = row.cells[0].textContent;
      const userRecords = JSON.parse(localStorage.getItem(storageKey) || '[]');
      const recordIndex = userRecords.findIndex(r => r.date === date);
      
      if (recordIndex !== -1) {
        if (isOngoing) {
          userRecords[recordIndex].duration = '进行中';
          row.cells[2].textContent = '进行中';
        } else {
          let prev = parseInt(userRecords[recordIndex].rawSeconds || 0);
          let now = parseInt(useTimeSec || 0);
          if (userRecords[recordIndex].duration !== '进行中') now += prev;
          userRecords[recordIndex].rawSeconds = now;
          userRecords[recordIndex].duration = formatDuration(now);
          row.cells[2].textContent = userRecords[recordIndex].duration;
          
          // 器材类型追加逻辑
          let eq = getStudentEquipmentType(deviceVariables.equipment_type, currentUser);
          let eqs = userRecords[recordIndex].equipment.split(',');
          if(!eqs.includes(eq)) {
            userRecords[recordIndex].equipment += ',' + eq;
            row.cells[1].textContent = userRecords[recordIndex].equipment;
          }
        }
        
        // 保存回本地存储
        localStorage.setItem(storageKey, JSON.stringify(userRecords));
      }
    }
    // ... existing code ...
    function formatTotalDuration(sec){sec=parseInt(sec)||0;let h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;let str='';if(h)str+=h+'小时';if(m||h)str+=m+'分钟';str+=s+'秒';return str;}
    function updateTotalHours(userId) {
      const totalHoursElement = document.getElementById('total-year-hours');
      if (!totalHoursElement) return;
      const userRecords = JSON.parse(localStorage.getItem(`history_${userId}`) || '[]');
      let totalSeconds = 0;
      userRecords.forEach(r=>{totalSeconds += parseInt(r.rawSeconds||0);});
      totalHoursElement.textContent = formatTotalDuration(totalSeconds);
    }
    // 删除选中异常记录
    document.getElementById('delete-exception-btn').onclick=function(){
      let sel=document.querySelectorAll('.exception-select:checked');
      if(!sel.length)return alert('请先选择要删除的记录');
      if(!confirm('确定要删除选中记录吗？'))return;
      let records=getExceptionRecords();
      sel.forEach(box=>{
        let id=box.getAttribute('data-id'),date=box.getAttribute('data-date');
        let idx=records.findIndex(r=>r.accountId==id&&r.date==date);
        if(idx>-1)records.splice(idx,1);
      });
      localStorage.setItem('exceptionRecords',JSON.stringify(records));
      updateExceptionTableDisplay();
    }
  </script>
  <!-- 引入本地二维码库 -->
  <script src="qrcode.min.js"></script>
</body>
</html>